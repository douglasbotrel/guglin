
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Aplicativo turístico interativo com mapa, busca e consentimento LGPD">
  <title>Guglin - Diamantina - MG</title>

  <!-- CSS Externo -->
  <link rel="stylesheet" href="styless.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="source/jquery-ui.min.css">
  <link rel="stylesheet" href="plugins/sidebar/L.Control.Sidebar.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css">
  <link rel="stylesheet" href="plugins/mouseposition/L.Control.MousePosition.css">
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css">
  <link rel="stylesheet" href="plugins/minimap/Control.MiniMap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

  <!-- JS Externo -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" defer></script>
  <script src="source/jquery-ui.min.js" defer></script>
  <script src="plugins/sidebar/L.Control.Sidebar.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js" defer></script>
  <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js" defer></script>
  <script src="plugins/mouseposition/L.Control.MousePosition.js" defer></script>
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js" defer></script>
  <script src="plugins/minimap/Control.MiniMap.min.js" defer></script>
  <script src="plugins/ajax/leaflet.ajax.js" defer></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js" defer></script>

  <!-- CSS Inline -->
  <style>
    body {
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #ffffff;
    }
    #mapweb { height: calc(100vh - 30px); width: 100%; }

    /* Painel retrátil superior */
    .search-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 999;
      transition: top 0.3s;
    }
    .search-panel {
      background-color: white;
      border-radius: 10px;
      margin: 6px auto;
      width: max-content;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .search-header {
      padding: 8px 16px;
      font-weight: bold;
      background: #f0f0f0;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }
    .search-body {
      padding: 8px;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .search-container.open .search-body { display: flex; }
    .search-body input {
      border: 1px solid #ccc;
      padding: 6px 10px;
      border-radius: 20px;
      width: 160px;
      outline: none;
    }
    .search-buttons button {
      background-color: white;
      border: none;
      padding: 6px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
    }
    /* Painel fechado por padrão */
    #searchContainer .search-body { display: none; }
    #searchContainer.open .search-body { display: block; }
    #searchContainer .search-header {
      cursor: pointer;
      user-select: none;
    }

    .whatsapp-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: #25D366;
      color: white;
      font-size: 24px;
      padding: 12px;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      text-decoration: none;
      z-index: 10000;
    }

    /* Pop-up de resultados */
    #resultadoBusca {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }
    #resultadoBusca .conteudo {
      background: white;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 10px;
      padding: 16px;
      font-family: sans-serif;
    }
    #resultadoBusca strong { font-size: 1.1rem; display: block; margin-bottom: 10px; }
    #listaResultados { list-style-type: disc; padding-left: 20px; font-size: 1rem; margin: 0; }
    #listaResultados li { margin-bottom: 6px; cursor: pointer; }
    #fecharPopupBusca {
      margin-top: 20px; width: 100%;
      background-color: #f44336;
      color: white; border: none;
      border-radius: 8px; padding: 10px;
      font-size: 1rem; font-weight: bold; cursor: pointer;
    }

    /* POPUP EM TELA GRANDE (layout) */
    .leaflet-container .fullpopup .leaflet-popup-content-wrapper{
      width: 88vw; max-width: 880px;
      max-height: 78vh;              /* mantém o limite */
      border-radius: 18px; padding: 0; overflow: hidden;
      box-shadow: 0 14px 36px rgba(0,0,0,.35);
    }
    .leaflet-container .fullpopup .leaflet-popup-content{ margin:0; padding:0; }
    .leaflet-container .fullpopup .leaflet-popup-tip{ display:none; }

    .popup-big{ display:flex; flex-direction:column; background:#fff; }
    .popup-big__title{ padding:18px 18px 10px; font-size:22px; line-height:1.25; font-weight:700; color:#222; }
    .popup-big__media{ width:100%; height:32vh; overflow:hidden; }
    .popup-big__media img{ width:100%; height:100%; display:block; object-fit:cover; }
    .popup-big__desc{
      padding:12px 18px; flex:1 1 auto; overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      color:#333; font-size:14px; line-height:1.5;
    }
    .popup-big__actions{
      padding:12px 18px 3px;  /* topo 12px, laterais 18px, baixo 3px */
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
      border-top:1px solid #eee;
    }
    .popup-btn{
      height:46px; display:inline-flex; align-items:center; justify-content:center;
      gap:8px; font-size:15px; font-weight:700; border:0; border-radius:12px; color:#fff; cursor:pointer;
    }
    .popup-btn--close{ background:#f44336; }
    .popup-btn--route{ background:#28a745; }
    .popup-btn i{ font-size:16px; }

    @media (max-width: 420px){
      .leaflet-container .fullpopup .leaflet-popup-content-wrapper{
        width:94vw; max-height:80vh; /* sem height fixa */
      }
    }

    /* Splash */
    #splash { position:fixed; top:0; left:0; width:100vw; height:100vh; background:#ffffff; display:flex; align-items:center; justify-content:center; z-index:99999; }
    #splash .logo { width:min(72vw, 280px); height:auto; margin-bottom:16px; }
    .spinner { width:38px; height:38px; border-radius:50%; border:4px solid #cfe0ff; border-top-color:#0b376b; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #splash.hide { display:none; }

    /* Barra inferior */
    .footer-bar { position:fixed; bottom:0; left:0; right:0; height:56px; background:#ffffff; border-top:1px solid #ddd; display:flex; justify-content:space-around; align-items:center; z-index:9999; font-family:sans-serif; }
    .footer-bar button { flex:1; height:100%; background:none; border:none; outline:none; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:11px; color:#444; cursor:pointer; }
    .footer-bar button i { font-size:18px; margin-bottom:2px; }
    .footer-bar button.active { color:#007bff; }
    .footer-credito { position:fixed; bottom:5px; left:0; right:0; text-align:center; font-size:12px; color:#555; z-index:999; font-family:sans-serif; }

    /* Ícones de evento */
    .event-icon-gray, .event-icon-yellow, .event-icon-green { display:block; border-radius:50%; border:1px solid #D2691E; }
    .event-icon-gray  { width:10px; height:10px; background:#A52A2A; }
    .event-icon-yellow{ width:14px; height:14px; background:#FFFF00; }
    .event-icon-green { width:18px; height:18px; background:#7CFC00; }

    /* Painel de Eventos (mesmo visual do popup de busca) */
      #painelEventos{
        position:fixed; top:0; left:0; width:100vw; height:100vh;
        background:rgba(0,0,0,.6); z-index:10000; display:none;
        justify-content:center; align-items:center; padding:10px;
      }
      #painelEventos .conteudo{
        background:#fff; max-width:520px; width:100%;
        max-height:90vh; overflow-y:auto; border-radius:10px; padding:16px;
        font-family:sans-serif;
      }
      #painelEventos h3{ margin:0 0 10px; font-size:18px; }
      #painelEventos h4{ margin:14px 0 6px; font-size:14px; color:#333; }
      #listaEventos .event-item{ padding:10px 0; border-bottom:1px solid #eee; }
      #listaEventos .event-line{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      #listaEventos .event-name{ font-weight:700; }
      #listaEventos .event-date{ font-size:12px; color:#555; }
      #listaEventos .event-info{ margin-top:4px; font-size:13px; color:#333; }
      #listaEventos .event-go{
        margin-top:6px; background:#28a745; color:#fff; border:0; border-radius:8px;
        padding:6px 10px; font-weight:700; cursor:pointer;
      }
      #fecharPainelEventos{
        margin-top:14px; width:100%; background:#f44336; color:#fff; border:0;
        border-radius:8px; padding:10px; font-weight:700; cursor:pointer;
      }

      /* Painéis sobrepostos (Eventos/Rotas) */
      #painelEventos, #painelRotas{
        position:fixed; top:0; left:0; width:100vw; height:100vh;
        background:rgba(0,0,0,.6); z-index:10000; display:none;
        justify-content:center; align-items:center; padding:10px;
      }
      #painelEventos .conteudo, #painelRotas .conteudo{
        background:#fff; max-width:520px; width:100%;
        max-height:90vh; overflow-y:auto; border-radius:10px; padding:16px;
        font-family:sans-serif;
      }
      #painelRotas h3{ margin:0 0 10px; font-size:18px; }

      /* Lista de rotas */
      #listaRotas .route-item{ padding:10px 0; border-bottom:1px solid #eee; }
      #listaRotas .route-line{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      #listaRotas .route-name{ font-weight:700; }
      #listaRotas .route-dist{ font-size:12px; color:#555; }
      #listaRotas .route-info{ margin-top:4px; font-size:13px; color:#333; }
      #listaRotas .route-actions{ margin-top:6px; display:flex; gap:8px; }
      #listaRotas .route-actions button{
        background:#eee; color:#222; border:0; border-radius:8px;
        padding:6px 10px; font-weight:700; cursor:pointer;
      }
      #listaRotas .route-actions .route-map{ background:#28a745; color:#fff; }
      #fecharPainelRotas{
        margin-top:14px; width:100%; background:#f44336; color:#fff; border:0;
        border-radius:8px; padding:10px; font-weight:700; cursor:pointer;
      }

      /* Ícone custom do "Estou aqui" */
      .leaflet-div-icon.user-marker{
        width:44px; height:44px;
        border-radius:50%;
        background:#fff;                 /* preto -> branco */
        border:2px solid #28a745;        /* aro verde para contraste */
        box-shadow:0 2px 8px rgba(0,0,0,.25);
        display:flex; align-items:center; justify-content:center;
      }
      .leaflet-div-icon.user-marker svg{ display:block; width:32px; height:32px; }

  </style>
</head>
<body>

  <!-- Splash -->
  <div id="splash">
    <img class="logo" src="img/guglin-logo.png" alt="Guglin">
    <div class="spinner" aria-label="Carregando"></div>
  </div>

  <!-- Painel de busca -->
  <div class="search-container" id="searchContainer">
    <div class="search-panel">
      <div class="search-header" onclick="toggleSearchPanel()">▲ Ferramentas</div>
      <div class="search-body">
        <input id="searchBox" placeholder="Buscar...">
        <div class="search-buttons">
          <button id="searchBtn" title="Buscar"><i class="fas fa-search"></i></button>
          <button id="clearBtn" title="Limpar"><i class="fas fa-times"></i></button>
          <button id="btnResetMap" title="Centralizar mapa"><i class="fas fa-crosshairs"></i></button>
          <button id="btnMyLocation" title="Minha localização"><i class="fas fa-location-arrow"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pop-up de resultados -->
  <div id="resultadoBusca">
    <div class="conteudo">
      <strong>Resultados da busca:</strong>
      <ul id="listaResultados"></ul>
      <button id="fecharPopupBusca">✕ Fechar</button>
    </div>
  </div>

  <!-- Painel de Eventos -->
  <div id="painelEventos" aria-hidden="true">
    <div class="conteudo">
      <h3>Eventos</h3>
      <div id="listaEventos"></div>
      <button id="fecharPainelEventos">✕ Fechar</button>
    </div>
  </div>

    <!-- Painel de Rotas -->
  <div id="painelRotas" aria-hidden="true">
    <div class="conteudo">
      <h3>Rotas</h3>
      <div id="listaRotas"></div>
      <button id="fecharPainelRotas">✕ Fechar</button>
    </div>
  </div>


  <!-- Mapa -->
  <div id="mapweb"></div>

  <!-- Botão WhatsApp -->
  <a href="https://wa.me/5563984406893" target="_blank" class="whatsapp-btn" title="Contato via WhatsApp">
    <i class="fab fa-whatsapp"></i>
  </a>

  <!-- Barra inferior -->
  <div class="footer-bar">
    <button id="btnHistorica"><i class="fas fa-landmark"></i><span>Histórica</span></button>
    <button id="btnRotas"><i class="fas fa-route"></i><span>Rotas</span></button>
    <button id="btnComercios"><i class="fas fa-store"></i><span>Comércios</span></button>
    <button id="btnEventos"><i class="fas fa-calendar-alt"></i><span>Eventos</span></button>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // Oculta splash após ~1,5 s
    const splashElement = document.getElementById('splash');
    setTimeout(() => {
      if (splashElement) splashElement.classList.add('hide');
      if (typeof initApp === 'function') initApp();
      if (typeof initConsent === 'function') initConsent();
    }, 1500);

    function toggleSearchPanel() {
      const container = document.getElementById('searchContainer');
      const header = container.querySelector('.search-header');
      const isOpen = container.classList.toggle('open');
      header.innerText = isOpen ? '▼ Ferramentas' : '▲ Ferramentas';
    }
    window.toggleSearchPanel = toggleSearchPanel;

    // Inicializa mapa
    const mymap = L.map('mapweb', {
      center: [-18.245, -43.598],
      zoom: 16,
      maxZoom: 18,
      minZoom: 14,
      attributionControl: false
    });
    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 23 }
    ).addTo(mymap);
    L.control.mousePosition({ position: 'bottomright' }).addTo(mymap);


    // Ícone "Estou aqui" (fundo branco + pessoa verde)
    const userHereIcon = L.divIcon({
      className: 'leaflet-div-icon user-marker',
      iconSize: [44, 44],
      iconAnchor: [22, 22],
      html: `
        <svg viewBox="0 0 48 48" aria-hidden="true">
          <!-- fundo branco (já vem do CSS); desenho verde -->
          <!-- cabeça -->
          <circle cx="24" cy="17" r="7" fill="#28a745"></circle>
          <!-- ombros/corpo -->
          <rect x="12" y="26" width="24" height="14" rx="7" fill="#28a745"></rect>
        </svg>
      `
    });

    // Pane para eventos (garante ficar acima dos polígonos)
    mymap.createPane('eventsPane');
    mymap.getPane('eventsPane').style.zIndex = 650;

    // Botão "X" para limpar rotas
    function addCloseButtonToRouteControl() {
      if (!window.routeControl) return;
      const container = window.routeControl.getContainer();
      if (!container || container.querySelector('.route-clear-btn')) return;
      const btn = document.createElement('button');
      btn.className = 'route-clear-btn';
      btn.innerHTML = '×';
      btn.title = 'Limpar rota';
      Object.assign(btn.style, {
        position: 'absolute', top: '5px', right: '5px', width: '24px', height: '24px',
        lineHeight: '20px', background: '#f44336', color: 'white', border: 'none',
        borderRadius: '50%', cursor: 'pointer', textAlign: 'center', fontSize: '18px'
      });
      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        try { mymap.removeControl(window.routeControl); } catch(e){}
        window.routeControl = null;
      });
      container.appendChild(btn);
    }

    // Estilos
    const highlightStyle = { color:'#3399FF', fillColor:'#3399FF', fillOpacity:0.5, weight:2 };
    const defaultStyle   = { color:'#DCDCDC', fillColor:'#D3D3D3', fillOpacity:0.3, weight:1 };

    // Utilidades
    function sanitizeName(nome) {
      return String(nome || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\s+/g, '')
        .replace(/[^a-zA-Z0-9_-]/g, '');
    }

    function buildPopupContent(nome, descricao, linkOpcional){
      const sanitized = sanitizeName(nome);
      let imgs = '';
      ['jpg','png'].forEach(ext=>{
        imgs += `<img loading="lazy" decoding="async" src="img/${sanitized}.${ext}" alt="${nome}"
                   onerror="this.style.display='none'">`;
      });
      return `
        <div class="popup-big">
          <div class="popup-big__title">${nome}</div>
          <div class="popup-big__media">${imgs}</div>
          <div class="popup-big__desc">
            ${descricao ? `<p>${descricao}</p>` : ''}
            ${linkOpcional ? `<p style="margin-top:8px;"><a href="${linkOpcional}" target="_blank">Mais informações</a></p>` : ''}
          </div>
          <div class="popup-big__actions">
            <button type="button" class="popup-close-btn popup-btn popup-btn--close">
              <i class="fas fa-times"></i> Fechar
            </button>
            <button type="button" class="popup-route-btn popup-btn popup-btn--route">
              <i class="fas fa-route"></i> Rota para cá
            </button>
          </div>
        </div>`;
    }

    function parseDateStr(str) {
      if (!str) return null;
      if (str.includes('-')) return new Date(str);
      if (str.includes('/')) {
        const parts = str.split('/');
        if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
      }
      const d = new Date(str);
      return isNaN(d) ? null : d;
    }
    const today = new Date(); today.setHours(0,0,0,0);
    const endDate = new Date(today); endDate.setDate(today.getDate() + 6);

    // 1. UCEstadual
    L.geoJSON.ajax('data/ucestadual.geojson', {
      style: () => ({ color:'#90EE90', weight:2, fillColor:'#90EE90', fillOpacity:0.3 })
    }).addTo(mymap);

    // 2. Polígonos (locais)
    let locaisLayer = L.geoJSON.ajax('data/poligonos.geojson', {
      style: () => defaultStyle,
      onEachFeature: function(feature, layer) {
        const p = feature.properties || {};
        const nomeFeat = p.Nome || p.nome || 'Sem nome';
        const descricao = p.Descricao || p.descricao || p.Detalhe || p.detalhe || '';
        const link = p.Link || p.link || null;

        // --- Caches para performance da busca ---
        const kwParts = [
          p.Nome || p.nome, p.Tipo || p.tipo,
          p.Detalhe || p.detalhe, p.Descricao || p.descricao
        ].filter(Boolean);
        layer._kw = kwParts.join(' ').toLowerCase();
        layer._center = (layer.getBounds && layer.getBounds().getCenter()) || null;
        layer._isHighlighted = false;

        const popupHtml = buildPopupContent(nomeFeat, descricao, link);
        layer.bindPopup(popupHtml, {
          className: 'fullpopup',
          closeButton: false,
          maxWidth: 10000,
          autoPanPaddingTopLeft: [10, 80]
        });

        layer.on('popupopen', function(e) {
          const popEl = e.popup.getElement();
          if (!popEl) return;

          const closeBtn = popEl.querySelector('.popup-close-btn, .popup-btn--close');
          if (closeBtn) closeBtn.addEventListener('click', () => mymap.closePopup());

          const routeBtn = popEl.querySelector('.popup-route-btn, .popup-btn--route');
          if (routeBtn) {
            routeBtn.addEventListener('click', () => {
              const dest = layer._center || layer.getBounds().getCenter();
              const usrMrk = window.userLocationMarker;
              if (usrMrk) {
                const origin = usrMrk.getLatLng();
                if (window.routeControl) mymap.removeControl(window.routeControl);
                window.routeControl = L.Routing.control({
                  waypoints: [origin, dest],
                  routeWhileDragging: false,
                  collapsible: true,
                  router: L.Routing.osrmv1({
                    profile:'car',
                    serviceUrl:'https://router.project-osrm.org/route/v1'
                  })
                }).addTo(mymap);
                window.routeControl.once('routesfound', addCloseButtonToRouteControl);
              } else {
                alert('Localização do usuário não disponível.');
              }
            });
          }
        });
      }
    }).addTo(mymap);
    locaisLayer.bringToFront();

    // 3. Eventos (em pane próprio)
      const eventsIndex = [];
      let eventsLoaded = false;

      function formatDate(d){
        if (!(d instanceof Date) || isNaN(d)) return 'Sem data';
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }
      function sameDay(a,b){
        return a.getFullYear()===b.getFullYear() &&
               a.getMonth()===b.getMonth() &&
               a.getDate()===b.getDate();
      }

      const eventosLayer = L.geoJSON.ajax('data/eventos.geojson', {
        pointToLayer: function (feature, latlng) {
          const p = (feature && feature.properties) || {};
          const dateObj = parseDateStr(String(p.data || p.Data || '').trim());

          let statusClass = 'event-icon-gray';
          if (dateObj) {
            if (sameDay(dateObj, today)) statusClass = 'event-icon-green';
            else if (dateObj >= today && dateObj <= endDate) statusClass = 'event-icon-yellow';
          }
          const iconSize = statusClass === 'event-icon-green' ? [18,18]
                         : statusClass === 'event-icon-yellow' ? [14,14] : [10,10];
          const icon = L.divIcon({
            html: `<span class="${statusClass}"></span>`,
            className: '', iconSize, iconAnchor: [iconSize[0]/2, iconSize[1]/2]
          });

          const marker = L.marker(latlng, { icon, pane:'eventsPane' });

          const nomeEv = p.Estabeleci || p.Nome || 'Evento';
          const descEv = p.Evento || p.Detalhe || p.Descricao || p.descricao || '';
          const linkEv = p.Link || p.link || null;
          const popupHtml = buildPopupContent(nomeEv, descEv, linkEv);

          marker.bindPopup(popupHtml, {
            className: 'fullpopup', closeButton: false, maxWidth: 10000, autoPanPaddingTopLeft: [10, 80]
          });

          marker.on('popupopen', function (e) {
            const popEl = e.popup.getElement();
            if (!popEl) return;

            const closeBtn = popEl.querySelector('.popup-close-btn, .popup-btn--close');
            if (closeBtn) closeBtn.addEventListener('click', () => mymap.closePopup());

            const routeBtn = popEl.querySelector('.popup-route-btn, .popup-btn--route');
            if (routeBtn) {
              routeBtn.addEventListener('click', function () {
                const dest = marker.getLatLng();
                const usrMrk = window.userLocationMarker;
                if (usrMrk) {
                  const origin = usrMrk.getLatLng();
                  if (window.routeControl) mymap.removeControl(window.routeControl);
                  window.routeControl = L.Routing.control({
                    waypoints: [origin, dest],
                    routeWhileDragging: false,
                    collapsible: true,
                    router: L.Routing.osrmv1({ profile:'car', serviceUrl:'https://router.project-osrm.org/route/v1' })
                  }).addTo(mymap);
                  window.routeControl.once('routesfound', addCloseButtonToRouteControl);
                } else {
                  alert('Localização do usuário não disponível.');
                }
              });
            }
          });

          // Indexa para a lista do footer
          eventsIndex.push({
            name: nomeEv,
            info: descEv,
            date: dateObj,
            marker: marker
          });

          return marker;
        }
      }).addTo(mymap);
      eventosLayer.on('data:loaded', () => { eventsLoaded = true; });

      // ===== Handler do botão "Eventos" no footer =====
      document.getElementById('btnEventos').addEventListener('click', () => {
        const painel = document.getElementById('painelEventos');
        const lista = document.getElementById('listaEventos');
        lista.innerHTML = '';

        if (!eventsLoaded && eventsIndex.length === 0) {
          lista.innerHTML = '<p>Carregando eventos...</p>';
          painel.style.display = 'flex';
          return;
        }

        // Ordena por data (mais próximo primeiro)
        const withDate = eventsIndex.filter(e => e.date instanceof Date && !isNaN(e.date))
                                    .sort((a,b)=> a.date - b.date);
        const todayList = withDate.filter(e => sameDay(e.date, today));
        const next6List = withDate.filter(e => e.date > today && e.date <= endDate);
        const futureList = withDate.filter(e => e.date > endDate);
        const noDateList = eventsIndex.filter(e => !e.date || isNaN(e.date));

        function section(title, arr){
          if (!arr.length) return;
          const h4 = document.createElement('h4');
          h4.textContent = title;
          lista.appendChild(h4);

          arr.forEach(ev => {
            const wrap = document.createElement('div');
            wrap.className = 'event-item';
            wrap.innerHTML = `
              <div class="event-line">
                <span class="event-name">${ev.name}</span>
                <span class="event-date">— ${formatDate(ev.date)}</span>
              </div>
              <div class="event-info">${ev.info || ''}</div>
              <button class="event-go">Ver no mapa</button>
            `;
            wrap.querySelector('.event-go').addEventListener('click', () => {
              painel.style.display = 'none';
              mymap.setView(ev.marker.getLatLng(), 17);
              ev.marker.openPopup();
            });
            lista.appendChild(wrap);
          });
        }

        section('Hoje', todayList);
        section('Próximos 6 dias', next6List);
        section('Futuro', futureList);
        if (noDateList.length) section('Sem data', noDateList);

        painel.style.display = 'flex';
      });
      document.getElementById('fecharPainelEventos')
        .addEventListener('click', ()=>{ document.getElementById('painelEventos').style.display='none'; });


    // ===== Painel / botão "Rotas" =====
      function montarListaRotas(){
        const painel = document.getElementById('painelRotas');
        const lista  = document.getElementById('listaRotas');
        lista.innerHTML = '';

        if (!rotasLoaded && rotasIndex.length === 0) {
          lista.innerHTML = '<p>Carregando rotas...</p>';
          painel.style.display = 'flex';
          return;
        }

        const userLL = window.userLocationMarker ? window.userLocationMarker.getLatLng() : null;

        // calcula distância do usuário e ordena (mais próximo primeiro)
        const arr = rotasIndex.map(r => ({
          ...r,
          userDist: userLL ? minDistanceToRouteMeters(userLL, r.coords) : NaN
        })).sort((a,b)=>{
          const ax = isNaN(a.userDist) ? Infinity : a.userDist;
          const bx = isNaN(b.userDist) ? Infinity : b.userDist;
          return ax - bx;
        });

        arr.forEach(r => {
          const distUserTxt = isNaN(r.userDist) ? '—' : formatKm(r.userDist);
          const item = document.createElement('div');
          item.className = 'route-item';
          item.innerHTML = `
            <div class="route-line">
              <span class="route-name">${r.name}</span>
              <span class="route-dist">— ${distUserTxt} de você</span>
            </div>
            <div class="route-info">Distância total da rota: ${formatKm(r.lengthMeters)}</div>
            <div class="route-actions">
              <button class="route-map">Ver no mapa</button>
              <button class="route-more">Mais informações</button>
            </div>
          `;

          // Ver no mapa: enquadra a rota e abre o popup
          item.querySelector('.route-map').addEventListener('click', () => {
            painel.style.display = 'none';
            mymap.fitBounds(r.bounds, { padding:[20,20] });
            r.layer.openPopup();
          });

          // Mais informações: abre o mesmo popup (com possível link)
          item.querySelector('.route-more').addEventListener('click', () => {
            painel.style.display = 'none';
            mymap.fitBounds(r.bounds, { padding:[20,20] });
            r.layer.openPopup();
          });

          lista.appendChild(item);
        });

        painel.style.display = 'flex';
      }

      document.getElementById('btnRotas').addEventListener('click', montarListaRotas);
      document.getElementById('fecharPainelRotas')
        .addEventListener('click', ()=>{ document.getElementById('painelRotas').style.display='none'; });

      // Se a localização aparecer depois de o painel estar aberto, atualiza as distâncias
      mymap.on('locationfound', (e) => {
      // ignora jitter <= 4m
      if (lastUserLL && mymap.distance(lastUserLL, e.latlng) <= 4) return;
      lastUserLL = e.latlng;

      if (!window.userLocationMarker) {
        // >>> trocado para usar o ícone custom
        window.userLocationMarker = L.marker(e.latlng, { icon: userHereIcon }).addTo(mymap);
      } else {
        window.userLocationMarker.setLatLng(e.latlng);
      }

      if (firstLocation) {
        mymap.setView(e.latlng, 16);
        window.userLocationMarker.bindPopup('Estou aqui').openPopup();
        firstLocation = false;
      }
    });

    // ===== 4. Caminhos (rotas) =====
    const rotasIndex = [];
    let rotasLoaded = false;

    function formatKm(m){
      if(!isFinite(m)) return '—';
      if(m < 1000) return `${m.toFixed(0)} m`;
      return `${(m/1000).toFixed(2)} km`;
    }

    // Comprimento total do MultiLineString (soma dos segmentos)
    function lengthMultiLineMeters(coords){ // coords: [ [ [lng,lat], ... ], [ ... ] ]
      let total = 0;
      coords.forEach(line=>{
        for(let i=1;i<line.length;i++){
          const a = L.latLng(line[i-1][1], line[i-1][0]);
          const b = L.latLng(line[i][1],   line[i][0]);
          total += mymap.distance(a,b);
        }
      });
      return total;
    }

    // Menor distância (em m) do usuário até qualquer vértice da rota
    function minDistanceToRouteMeters(userLL, coords){
      if(!userLL) return NaN;
      let min = Infinity;
      coords.forEach(line=>{
        line.forEach(pt=>{
          const ll = L.latLng(pt[1], pt[0]);
          const d  = mymap.distance(userLL, ll);
          if (d < min) min = d;
        });
      });
      return min;
    }

    const caminhosLayer = L.geoJSON.ajax('data/caminho.geojson', {
        style: () => ({ color:'#DAA520', weight:4 }),
        onEachFeature: function (feature, layer) {
          const p = feature.properties || {};
          const nome = p.Onde || p.Nome || 'Rota';

          const lengthMeters = (typeof p.Distancia === 'number')
            ? p.Distancia * 1000
            : lengthMultiLineMeters(feature.geometry.coordinates);

          const desc = `
            Distância total: ${formatKm(lengthMeters)}
            ${p.Descricao ? `<br>${p.Descricao}` : ''}
            ${p.Info ? `<br>${p.Info}` : ''}
          `;
          const link = p.Link || p.link || null;

          layer.bindPopup(
            buildPopupContent(nome, desc, link),
            { className:'fullpopup', closeButton:false, maxWidth:10000, autoPanPaddingTopLeft:[10,80] }
          );

          // >>> FIX: liga os botões do popup dos "caminhos"
          layer.on('popupopen', function (e) {
            const popEl = e.popup.getElement();
            if (!popEl) return;

            // Fechar
            const closeBtn = popEl.querySelector('.popup-close-btn, .popup-btn--close');
            if (closeBtn) closeBtn.addEventListener('click', () => mymap.closePopup());

            // Rota para cá
            const routeBtn = popEl.querySelector('.popup-route-btn, .popup-btn--route');
            if (routeBtn) {
              routeBtn.addEventListener('click', () => {
                const dest = layer.getBounds().getCenter(); // centro da rota
                const usrMrk = window.userLocationMarker;

                if (!usrMrk) { alert('Localização do usuário não disponível.'); return; }

                const origin = usrMrk.getLatLng();
                if (window.routeControl) try { mymap.removeControl(window.routeControl); } catch(e){}

                window.routeControl = L.Routing.control({
                  waypoints: [origin, dest],
                  routeWhileDragging: false,
                  collapsible: true,
                  router: L.Routing.osrmv1({
                    profile: 'car',
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                  })
                }).addTo(mymap);

                window.routeControl.once('routesfound', addCloseButtonToRouteControl);
              });
            }
          });
          // <<< FIM DO FIX

          // index para o painel de rotas (se já estiver usando)
          rotasIndex.push({
            name: nome,
            lengthMeters,
            coords: feature.geometry.coordinates,
            layer,
            bounds: layer.getBounds()
          });
        }
      }).addTo(mymap);

      caminhosLayer.on('data:loaded', ()=>{ rotasLoaded = true; });



    // 5. Busca (versão otimizada)
    function buscarPalavraChave() {
      const keyword = document.getElementById('searchBox').value.trim().toLowerCase();
      const listaResultados = document.getElementById('listaResultados');
      const painel = document.getElementById('resultadoBusca');

      const frag = document.createDocumentFragment();
      let matches = 0;

      locaisLayer.eachLayer((layer) => {
        const hit = keyword && layer._kw && layer._kw.includes(keyword);

        if (hit && !layer._isHighlighted) {
          layer.setStyle(highlightStyle);
          layer.bringToFront();
          layer._isHighlighted = true;
        } else if (!hit && layer._isHighlighted) {
          layer.setStyle(defaultStyle);
          layer._isHighlighted = false;
        }

        if (hit) {
          matches++;
          const li = document.createElement('li');
          li.textContent = (layer.feature.properties.Nome || layer.feature.properties.nome || 'Sem nome');
          li.style.cursor = 'pointer';
          li.onclick = () => {
            if (layer._center) mymap.setView(layer._center, 17);
            layer.openPopup();
          };
          frag.appendChild(li);
        }
      });

      listaResultados.innerHTML = '';
      if (matches) {
        listaResultados.appendChild(frag);
      } else {
        listaResultados.innerHTML = '<li>Nenhum resultado encontrado.</li>';
      }
      painel.style.display = 'block';
    }

    document.getElementById('searchBtn').onclick = buscarPalavraChave;
    document.getElementById('searchBox').onkeydown = (e) => { if (e.key==='Enter') buscarPalavraChave(); };

    // Debounce ao digitar
    let _sbTimer;
    document.getElementById('searchBox').addEventListener('input', () => {
      clearTimeout(_sbTimer);
      _sbTimer = setTimeout(buscarPalavraChave, 220);
    });

    document.getElementById('clearBtn').onclick = () => {
      document.getElementById('searchBox').value = '';
      document.getElementById('resultadoBusca').style.display = 'none';
      locaisLayer.eachLayer((layer) => {
        if (layer._isHighlighted) {
          layer.setStyle(defaultStyle);
          layer._isHighlighted = false;
        }
      });
    };
    document.getElementById('btnResetMap').onclick = () => { mymap.setView([-18.245, -43.598], 16); };
    document.getElementById('fecharPopupBusca').addEventListener('click', () => {
      document.getElementById('resultadoBusca').style.display = 'none';
      locaisLayer.eachLayer((layer) => {
        if (layer._isHighlighted) {
          layer.setStyle(defaultStyle);
          layer._isHighlighted = false;
        }
      });
    });

    // 6. Localização do usuário (atualização em background com filtro)
    let firstLocation = true;
    let lastUserLL = null;

    document.getElementById('btnMyLocation').addEventListener('click', () => {
      firstLocation = true;
      mymap.locate({
        watch: true,
        enableHighAccuracy: true,
        maximumAge: 15000,
        timeout: 20000
      });
    });

    mymap.on('locationfound', (e) => {


      // ignora jitter <= 4m
      if (lastUserLL && mymap.distance(lastUserLL, e.latlng) <= 4) return;
      lastUserLL = e.latlng;

      if (!window.userLocationMarker) {
        window.userLocationMarker = L.marker(e.latlng).addTo(mymap);
      } else {
        window.userLocationMarker.setLatLng(e.latlng);
      }
      if (firstLocation) {
        mymap.setView(e.latlng, 16);
        window.userLocationMarker.bindPopup('Estou aqui').openPopup();
        firstLocation = false;
      }
    });

    mymap.on('locationerror', () => {
      alert('Não foi possível obter sua localização. Por favor, permita o acesso ou tente novamente.');
    });

  });
  </script>
</body>
</html>

