<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>dBGiX</title>

	<link rel="stylesheet" href="styless.css">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="source/jquery-ui.min.css">
	<link rel="stylesheet" href="plugins/sidebar/L.Control.Sidebar.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
	<link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css">
	<link rel="stylesheet" href="plugins/mouseposition/L.Control.MousePosition.css">
	<link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css">
	<link rel="stylesheet" href="plugins/minimap/Control.MiniMap.min.css">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>


	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet-src.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js"></script>
	<script src="source/jquery-ui.min.js"></script>
	<script src="plugins/sidebar/L.Control.Sidebar.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
	<script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
	<script src="plugins/mouseposition/L.Control.MousePosition.js"></script>
	<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.js"></script>
	<script src="plugins/minimap/Control.MiniMap.min.js">"></script>
	<script src="plugins/ajax/leaflet.ajax.js"></script>
	<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>


	<style>
        html, body {
            height: 100%;
            margin: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
    </style>


</head>
<body>


<!-- BUSCADOR (centralizado no topo) -->
  <div style="position:absolute; top:10px; left:50%; transform:translateX(-50%); z-index:1000; background:white; padding:10px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.3);">
    <input type="text" id="buscaRota" placeholder="Digite o nome ex: Igreja" style="width:180px;">
    <button onclick="buscarERotear()">Traçar Rota</button>
  </div>

  <script>
    // INICIALIZAÇÃO DO MAPA
    const mymap = L.map('mapweb', {
      center: [-18.24, -43.60],
      zoom: 14,
      attributionControl: false,
      zoomControl: false
    });

    // CAMADAS BASE
    const baseLayers = {
      "Carbon": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { maxZoom: 23 }),
      "ESRI Satélite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 23 }),
      "Open Street": L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 23 })
    };
    baseLayers["ESRI Satélite"].addTo(mymap);

    // CONTROLES
    const control_layers = L.control.layers(baseLayers, {}).addTo(mymap);
    L.control.scale({ position: 'bottomleft', maxWidth: 200, imperial: false }).addTo(mymap);
    L.control.polylineMeasure({ position: 'topright' }).addTo(mymap);
    L.control.mousePosition({ position: 'bottomright' }).addTo(mymap);

    // GEOLOCALIZAÇÃO DO USUÁRIO
    let userLocation = null;
    let controleRota = null;

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          userLocation = L.latLng(pos.coords.latitude, pos.coords.longitude);
          let customIcon = L.icon({
            iconUrl: 'https://images.icon-icons.com/3875/PNG/512/icon_icon_245067.png',
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -40]
          });
          L.marker(userLocation, { icon: customIcon })
            .addTo(mymap)
            .bindPopup("Você está aqui!")
            .openPopup();
          mymap.setView(userLocation, 16);
        },
        err => console.warn("Erro ao obter localização:", err.message),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    // FUNÇÃO DE NORMALIZAÇÃO DE TEXTO
    function normalizarTexto(texto) {
      return texto
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "_")
        .replace(/[^\w\-]/g, "")
        .toLowerCase();
    }

    // FUNÇÃO DE BUSCA E ROTA
    function buscarERotear() {
      let termo = document.getElementById('buscaRota').value.trim().toLowerCase();
      if (!userLocation) {
        alert("Localização do usuário não disponível.");
        return;
      }
      let destino = null;

      atracoes.eachLayer(layer => {
        let nome = (layer.feature.properties.Name || "").toLowerCase().replace(/\s+/g, '');
        if (nome.includes(termo)) {
          destino = layer.getLatLng();
        }
      });

      if (!destino) {
        alert("Ponto não encontrado.");
        return;
      }

      if (controleRota) mymap.removeControl(controleRota);

      controleRota = L.Routing.control({
        waypoints: [userLocation, destino],
        routeWhileDragging: false,
        show: false,
        addWaypoints: false,
        draggableWaypoints: false,
        createMarker: () => null,
        lineOptions: { styles: [{ color: '#3388ff', weight: 5 }] }
      }).addTo(mymap);

      mymap.fitBounds(L.latLngBounds([userLocation, destino]));
    }

    // LAYER: ATRAÇÕES
    const atracoes = L.geoJSON.ajax('data/atracoes.geojson', {
      pointToLayer: style_atracoes
    }).addTo(mymap);
    control_layers.addOverlay(atracoes, "Pontos Atrações");

    function style_atracoes(feature, latlng) {
      const tipo = feature.properties.tipo || "Outro";
      const nome = feature.properties.Name || "Sem nome";
      let iconUrl;

      switch (tipo) {
        case "Comercio": iconUrl = "icons/comercio.png"; break;
        case "Igreja": iconUrl = "icons/igreja.png"; break;
        case "Monumento": iconUrl = "icons/monumento.png"; break;
        case "Contrucoes": iconUrl = "icons/construcoes.png"; break;
        case "Evento": iconUrl = "icons/evento.png"; break;
        case "Estatua": iconUrl = "icons/estatua.png"; break;
        case "Cachoeira": iconUrl = "icons/cachoeira.png"; break;
        default: iconUrl = "icons/default.png";
      }

      const marker = L.marker(latlng, {
        icon: L.icon({ iconUrl, iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40] })
      });

      const imagemHTML = `
        <img src="img/${normalizarTexto(nome)}.jpg" alt="${nome}"
          onerror="this.onerror=null; this.src='img/${normalizarTexto(nome)}.png';"
          style="display:block; max-width:100%; height:auto; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.4); margin:0 auto;">
      `;

      marker.bindPopup(`
        <div style="text-align:center; padding:10px;">
          <strong>${nome}</strong><br><em>Tipo:</em> ${tipo}<br><br>${imagemHTML}
        </div>
      `);

      return marker;
    }

    // LAYER: ÁREA TOMBADA
    const tombado = L.geoJSON.ajax('data/areatombada.geojson', {
      style: feature => {
        const cor = feature.properties.Categoria === "IPHAN" ? "#FFD700" :
                    feature.properties.Categoria === "UNESCO" ? "#DAA520" : "#FFFAF0";
        return { color: cor, fillColor: cor, fillOpacity: 0.3 };
      }
    }).addTo(mymap);
    control_layers.addOverlay(tombado, "Área Tombada");

    // LAYER: ROTAS
    const rotas = L.geoJSON.ajax('data/rotas.geojson', {
      style: () => ({ color: "#ADFF2F" })
    }).addTo(mymap);
    control_layers.addOverlay(rotas, "Rotas");
	  
  </script>

</body>

</html>

