
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Aplicativo turístico interativo com mapa, busca e consentimento LGPD">
  <title>Guglin - Diamantina - MG</title>

  <!-- CSS Externo -->
  <link rel="stylesheet" href="styless.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="source/jquery-ui.min.css">
  <link rel="stylesheet" href="plugins/sidebar/L.Control.Sidebar.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css">
  <link rel="stylesheet" href="plugins/mouseposition/L.Control.MousePosition.css">
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css">
  <link rel="stylesheet" href="plugins/minimap/Control.MiniMap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">

  <!-- JS Externo -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" defer></script>
  <script src="source/jquery-ui.min.js" defer></script>
  <script src="plugins/sidebar/L.Control.Sidebar.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js" defer></script>
  <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js" defer></script>
  <script src="plugins/mouseposition/L.Control.MousePosition.js" defer></script>
  <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js" defer></script>
  <script src="plugins/minimap/Control.MiniMap.min.js" defer></script>
  <script src="plugins/ajax/leaflet.ajax.js" defer></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js" defer></script>

  <!-- CSS Inline Consolidado -->
  <style>
    /* ==== Ajustes de responsividade ==== */
    body {
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
    }
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: Arial, sans-serif;
    }
    #mapweb {
      height: calc(100vh - 30px);
      width: 100%;
    }

    /* Painel retrátil superior */
    .search-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 999;
      transition: top 0.3s;
    }

    .search-panel {
      background-color: white;
      border-radius: 10px;
      margin: 6px auto;
      width: max-content;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .search-header {
      padding: 8px 16px;
      font-weight: bold;
      background: #f0f0f0;
      cursor: pointer;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }

    .search-body {
      padding: 8px;
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .search-container.open .search-body {
      display: flex;
    }

    .search-body input {
      border: 1px solid #ccc;
      padding: 6px 10px;
      border-radius: 20px;
      width: 160px;
      outline: none;
    }

    .search-buttons button {
      background-color: white;
      border: none;
      padding: 6px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
    }

    /* Fechado por padrão */
    #searchContainer .search-body { display: none; }
    /* Quando aberto */
    #searchContainer.open .search-body { display: block; }
    #searchContainer .search-header {
      cursor: pointer;
      user-select: none;
    }

    .whatsapp-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: #25D366;
      color: white;
      font-size: 24px;
      padding: 12px;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      text-decoration: none;
      z-index: 10000;
    }

    #resultadoBusca {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }
    #resultadoBusca .conteudo {
      background: white;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 10px;
      padding: 16px;
      font-family: sans-serif;
    }
    #resultadoBusca strong {
      font-size: 1.1rem;
      display: block;
      margin-bottom: 10px;
    }
    #listaResultados {
      list-style-type: disc;
      padding-left: 20px;
      font-size: 1rem;
      margin: 0;
    }
    #listaResultados li {
      margin-bottom: 6px;
      cursor: pointer;
    }
    #fecharPopupBusca {
      margin-top: 20px;
      width: 100%;
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
    }
    .custom-icon {
      color: white; font-size: 16px;
      text-shadow: 0 0 2px rgba(0,0,0,0.6);
      pointer-events: none;
    }

    /* Ícone personalizado para eventos (festa) */
    .festa-icon {
      color: #e74c3c;
      font-size: 24px;
      text-shadow: 0 0 2px #ffffff;
    }

    @media screen and (max-width: 600px) {
      .search-container input { width: 120px; font-size: 14px; }
      .search-buttons button { font-size: 16px; padding: 6px; }
      .whatsapp-btn { bottom: 70px; right: 16px; }
    }

    .leaflet-popup-content-wrapper {
      max-width: 60vw !important;
      max-height: 50vh;
      overflow: auto;
    }
    .leaflet-popup-content img {
      max-width: 30vw;
      max-height: 20vh;
      height: auto;
      width: auto;
      display: block;
      margin: 0 auto;
      border-radius: 8px;
      box-shadow: 0 0 30px rgba(0,0,0,0.3);
    }
  </style>

  <style>
    .footer-credito {
      position: fixed;
      bottom: 5px;
      left: 0; right: 0;
      text-align: center;
      font-size: 12px;
      color: #555;
      z-index: 999;
      font-family: sans-serif;
    }
    @media screen and (max-width: 400px) {
      .search-body input { width: 110px; font-size: 13px; }
      #resultadoBusca .conteudo { max-width: 95vw; font-size: 0.9rem; }
      .leaflet-popup-content-wrapper { max-width: 80vw !important; }
    }
    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background-color: #ffffff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    #splash .logo {
      width: min(72vw, 280px);
      height: auto;
      margin-bottom: 16px;
    }
    .spinner {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 4px solid #cfe0ff;
      border-top-color: #0b376b;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #splash.hide { display: none; }

    .footer-bar {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 56px;
      background: #ffffff;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 9999;
      font-family: sans-serif;
    }
    .footer-bar button {
      flex: 1;
      height: 100%;
      background: none;
      border: none;
      outline: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #444;
      cursor: pointer;
    }
    .footer-bar button i {
      font-size: 18px;
      margin-bottom: 2px;
    }
    .footer-bar button.active { color: #007bff; }
  </style>
</head>

<body>
  <!-- Splash / Tela inicial -->
  <div id="splash">
    <img class="logo" src="img/guglin-logo.png" alt="Guglin">
    <div class="spinner" aria-label="Carregando"></div>
  </div>

  <!-- Painel de busca -->
  <div class="search-container" id="searchContainer">
    <div class="search-panel">
      <div class="search-header" onclick="toggleSearchPanel()">▲ Ferramentas</div>
      <div class="search-body">
        <input id="searchBox" placeholder="Buscar...">
        <div class="search-buttons">
          <button id="searchBtn" title="Buscar"><i class="fas fa-search"></i></button>
          <button id="clearBtn" title="Limpar"><i class="fas fa-times"></i></button>
          <button id="btnResetMap" title="Centralizar mapa"><i class="fas fa-crosshairs"></i></button>
          <button id="btnMyLocation" title="Minha localização"><i class="fas fa-location-arrow"></i></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pop‑up de resultados de busca -->
  <div id="resultadoBusca">
    <div class="conteudo">
      <strong>Resultados da busca:</strong>
      <ul id="listaResultados"></ul>
      <button id="fecharPopupBusca">✕ Fechar</button>
    </div>
  </div>

  <!-- Mapa -->
  <div id="mapweb"></div>

  <!-- WhatsApp -->
  <a href="https://wa.me/5563984406893" target="_blank" class="whatsapp-btn" title="Contato via WhatsApp">
    <i class="fab fa-whatsapp"></i>
  </a>

  <!-- Barra inferior -->
  <div class="footer-bar">
    <button id="btnHistorica"><i class="fas fa-landmark"></i><span>Histórica</span></button>
    <button id="btnRotas"><i class="fas fa-route"></i><span>Rotas</span></button>
    <button id="btnComercios"><i class="fas fa-store"></i><span>Comércios</span></button>
    <button id="btnEventos"><i class="fas fa-calendar-alt"></i><span>Eventos</span></button>
  </div>

  <!-- Scripts internos -->
  <script>
    /*
     * Encapsula toda a lógica em um manipulador de DOMContentLoaded.
     * Isso garante que todos os elementos do DOM estejam disponíveis
     * antes de executar o código e permite ocultar o splash e iniciar
     * a aplicação de maneira controlada.
     */
    document.addEventListener('DOMContentLoaded', function () {
      // Remove a tela de splash após 5 segundos e inicia funções opcionais
      const splashElement = document.getElementById('splash');
      setTimeout(() => {
        if (splashElement) splashElement.classList.add('hide');
        if (typeof initApp === 'function') initApp();
        if (typeof initConsent === 'function') initConsent();
      }, 5000);

      // Alterna abertura/fechamento do painel de busca
      function toggleSearchPanel() {
        const container = document.getElementById('searchContainer');
        const header = container.querySelector('.search-header');
        const isOpen = container.classList.toggle('open');
        header.textContent = isOpen ? '▼ Ferramentas' : '▲ Ferramentas';
      }
      // Disponibiliza a função no escopo global para ser chamada no HTML
      window.toggleSearchPanel = toggleSearchPanel;

      // Configuração inicial do mapa
      const mymap = L.map('mapweb', {
        center: [-18.245, -43.598],
        zoom: 16,
        maxZoom: 18,
        minZoom: 14,
        attributionControl: false
      });
      L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { maxZoom: 23 }
      ).addTo(mymap);
      L.control.mousePosition({ position: 'bottomright' }).addTo(mymap);
      L.control.scale({ position: 'topright' }).addTo(mymap);

      // Camadas de polígonos (basemapa removida)
      const camadas = [
        { nome: 'tombado', cor: '#000', dash: '4 6' },
        { nome: 'rotas', cor: '#FFE4B5', peso: 4 },
        { nome: 'ucestadual', cor: '#90EE90', preenchimento: true }
      ];
      camadas.forEach(({ nome, cor, dash = '', peso = 2, preenchimento = false }) => {
        if (nome === 'basemapa') return;
        L.geoJSON.ajax(`data/${nome}.geojson`, {
          style: () => ({
            color: cor,
            weight: peso,
            dashArray: dash,
            fillColor: preenchimento ? cor : 'transparent',
            fillOpacity: preenchimento ? 0.3 : 0
          })
        }).addTo(mymap);
      });

      // Estilos para destaques de busca
      const highlightStyle = { color: '#3399FF', fillColor: '#3399FF', fillOpacity: 0.5, weight: 2 };
      const defaultStyle   = { color: '#FF0000', fillColor: '#FF0000', fillOpacity: 0.3, weight: 1 };

      // Carrega pontos turísticos (locais)
      let locaisLayer = L.geoJSON.ajax('data/locais.geojson', {
        style: () => defaultStyle,
        onEachFeature: function (feature, layer) {
          const p = feature.properties;
          const nome = p.Nome || 'Sem nome';
          const tipo = p.Tipo || 'Tipo desconhecido';
          const detalhe = p.Detalhe || 'Sem detalhes';
          const link = p.Link;
          const fotoBase = p.foto;
          const MAX_PHOTOS = p.fotoCount || 5;
          let popupContent =
            `<div class='popup-content'><strong>${nome}</strong><br><em>${tipo}</em><br><p>${detalhe}</p>`;
          if (link) {
            popupContent += `<a href='${link}' target='_blank'>Mais informações</a><br>`;
          }
          if (fotoBase) {
            const exts = ['jpg', 'png'];
            for (let i = 1; i <= MAX_PHOTOS; i++) {
              const suffix = i === 1 ? '' : i;
              exts.forEach((ext) => {
                popupContent +=
                  `<img loading="lazy" class="popup-img" src='img/${fotoBase}${suffix}.${ext}' alt='${nome} ${suffix}' onerror="this.style.display='none'">`;
              });
            }
          }
          popupContent += '</div>';
          layer.bindPopup(popupContent);
        }
      }).addTo(mymap);
      locaisLayer.bringToFront();

      // === Eventos: carrega e exibe pontos de eventos conforme data ===
      // Função para converter string de data em objeto Date.
      // Suporta formatos ISO (YYYY-MM-DD) e DD/MM/YYYY.
      function parseDateStr(str) {
        if (!str) return null;
        if (str.includes('-')) return new Date(str);
        if (str.includes('/')) {
          const parts = str.split('/');
          if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        return new Date(str);
      }

      // Intervalo de datas válido: de hoje até seis dias adiante
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const endDate = new Date(today);
      endDate.setDate(today.getDate() + 6);

      // Ícone de festa para eventos
      const festaIcon = L.icon({
          iconUrl: 'img/event-icon.png',
          iconSize: [32, 32],
          iconAnchor: [16, 16],
          popupAnchor: [0, -16]
        });
    

      // Carrega a camada de eventos geojson
      L.geoJSON.ajax('data/eventos.geojson', {
        filter: function (feature) {
          const dataStr = feature.properties && feature.properties.data;
          if (!dataStr) return false;
          const dateObj = parseDateStr(dataStr);
          return dateObj && dateObj >= today && dateObj <= endDate;
        },
        pointToLayer: function (feature, latlng) {
          const p = feature.properties || {};
          const estabelecimento = p.Estabeleci || '';
          const endereco = p['Rua_N§'] || '';
          const bairro = p.Bairro || '';
          const evento = p.Evento || '';
          const dataEv = p.data || '';
          const popupContent =
            `<div class='popup-content'><strong>${estabelecimento}</strong><br>${endereco}<br>${bairro}<br>${evento}<br>${dataEv}</div>`;
          return L.marker(latlng, { icon: festaIcon }).bindPopup(popupContent);
        }
      }).addTo(mymap);

      // Função de busca por palavra-chave
      function buscarPalavraChave() {
        const keyword = document.getElementById('searchBox').value.trim().toLowerCase();
        const listaResultados = document.getElementById('listaResultados');
        const painel = document.getElementById('resultadoBusca');
        listaResultados.innerHTML = '';
        let encontrados = [];

        locaisLayer.eachLayer((layer) => {
          const p = layer.feature.properties;
          const match = [p.Nome, p.Tipo, p.Detalhe].some(
            (val) => val && val.toLowerCase().includes(keyword)
          );
          if (match) {
            layer.setStyle(highlightStyle);
            layer.bringToFront();
            encontrados.push(layer);
            const li = document.createElement('li');
            li.textContent = p.Nome;
            li.style.cursor = 'pointer';
            li.onclick = () => {
              mymap.setView(layer.getBounds().getCenter(), 17);
              layer.openPopup();
            };
            listaResultados.appendChild(li);
          } else {
            layer.setStyle(defaultStyle);
          }
        });

        if (encontrados.length) {
          painel.style.display = 'block';
        } else {
          listaResultados.innerHTML = '<li>Nenhum resultado encontrado.</li>';
          painel.style.display = 'block';
        }
      }

      // Associa botões de busca e filtros
      document.getElementById('searchBtn').onclick = buscarPalavraChave;
      document.getElementById('searchBox').onkeydown = (e) => {
        if (e.key === 'Enter') buscarPalavraChave();
      };
      document.getElementById('clearBtn').onclick = () => {
        document.getElementById('searchBox').value = '';
        document.getElementById('resultadoBusca').style.display = 'none';
        locaisLayer.eachLayer((layer) => layer.setStyle(defaultStyle));
      };
      document.getElementById('btnResetMap').onclick = () => {
        mymap.setView([-18.245, -43.598], 16);
      };

      // Botão para fechar resultados de busca
      const fecharBtn = document.getElementById('fecharPopupBusca');
      fecharBtn.addEventListener('click', () => {
        document.getElementById('resultadoBusca').style.display = 'none';
        locaisLayer.eachLayer((layer) => layer.setStyle(defaultStyle));
      });

      // Localização do usuário
      document.getElementById('btnMyLocation').addEventListener('click', () => {
        mymap.locate({ setView: true, maxZoom: 16 });
      });
      mymap.on('locationfound', (e) => {
        if (window.userLocationMarker) {
          mymap.removeLayer(window.userLocationMarker);
        }
        window.userLocationMarker = L.marker(e.latlng)
          .addTo(mymap)
          .bindPopup('Você está aqui')
          .openPopup();
      });
      mymap.on('locationerror', () => {
        alert('Não foi possível obter sua localização. Por favor, permita o acesso ou tente novamente.');
      });
    });
  </script>

  <div class="footer-credito">
    Desenvolvido por Guglin Tecnologias 2025
  </div>
</body>
</html>
